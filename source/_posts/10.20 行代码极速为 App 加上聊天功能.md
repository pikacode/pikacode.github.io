---
title: 20 行代码极速为 App 加上聊天功能
date: 2016.12.09 14:13
tags: [IM, JPush]
categories: [IM, JPush]
---

现在很多 App 都需要集成 IM 功能，今天就为大家分享一下集成 IM 基本功能的步骤。本文内容以 JMessage 为例。
[极光 IM ( JMessage )](https://docs.jiguang.cn/jmessage/client/im_sdk_ios/) = [极光推送 ( JPush )](https://docs.jiguang.cn/jpush/guideline/intro/) + IM，本篇只论述其中的 IM 部分，为大家快速集成 IM 功能提供一个简明的范例。

我们先来看一下 IM 的基本功能与本文内容的对应关系：
![](http://upload-images.jianshu.io/upload_images/1944178-d97bf9be09cdb788.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### line 0：准备工作
---
- [下载 SDK](https://docs.jiguang.cn/jmessage/resources/)
- [集成 SDK](https://docs.jiguang.cn/jmessage/client/jmessage_ios_guide/#_4)



### line 1：引入头文件
---
```objc
#import <JMessage/JMessage.h>
```
JMessage 核心头文件。这是唯一需要导入到你的项目里的头文件，它引用了内部需要用到的头文件。



### line 2：开启事件监听
---
```objc
[JMessage addDelegate:self withConversation:nil];
```
- 用于监听各种全局事件
- 建议写在 line 3 之前
- Parameters：
- delegate：填入对象需要实现 <JMessageDelegate>
- conversation：nil 监听所有通知，非 nil 监听指定会话



### line 3：启动 SDK
---
```objc
[JMessage setupJMessage:launchOptions
                 appKey:@"your appkey"
                channel:@"channel name"
       apsForProduction:NO
               category:nil];
```
- 建议写在 `application:didFinishLaunchingWithOptions:`
- Parameters：
- launchOptions：启动函数的参数 launchingOption
- appKey：获取方式 line 0 - 集成 SDK
- channel：应用的渠道名
- isProduction：是否为生产模式
- category：iOS8 新增通知快捷按钮参数



### line 4：注册新用户
---
```objc
[JMSGUser registerWithUsername:@"username" 
                      password:@"password"
             completionHandler:^(id resultObject, NSError *error) {
}];
```
Parameters：
- username：用户名
- password：密码
- handler：error 为 nil 时调用成功（下均同）



### line 5：登录
---
```objc
[JMSGUser loginWithUsername:@"username" 
                   password:@"password" 
          completionHandler:^(id resultObject, NSError *error) {
}];
```



### line 6：创建单聊会话
---
```objc
[JMSGConversation createSingleConversationWithUsername:@"username" 
                                     completionHandler:^(id resultObject, NSError *error) {
}];
```
- 会话是整个 IM 的核心，所有的消息行为都基于「会话」
- 该会话不存在会返回新会话，存在会返回已有会话
- Parameters：
- handler：正常返回时 resultObject 为 [JMSGConversation](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html) 会话对象
- ((JMSGConversation*)resultObject).target：会话的对方目标：
   - [用户对象 JMSGUser](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGUser.html)
   - [群组对象 JMSGGroup](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html)
- Related APIs：
- [创建单聊跨应用会话](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/createSingleConversationWithUsername:appKey:completionHandler:)
- [创建群聊会话](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/createGroupConversationWithGroupId:completionHandler:)



### line 7：发送文本消息
---
```objc
[(JMSGConversation*)resultObject sendTextMessage:@"text"];
```
- 转型 line 6 - handler 中的 `resultObject`，并发送文本消息
- Related APIs：
- [发送图片消息](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/sendImageMessage:)
- [发送语音消息](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/sendVoiceMessage:duration:)
- [发送文件消息](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/sendFileMessage:fileName:)
- [发送地理位置消息](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/sendLocationMessage:longitude:scale:address:)



### line 8~12：接收文本消息
---
```objc
- (void)onReceiveMessage:(JMSGMessage *)message error:(NSError *)error{
    if (message.content == kJMSGContentTypeText) {
        NSString *text = ((JMSGTextContent *)message.content).text;
    }
}
```
- 在 line 2 中添加了 <JMessageDelegate> 的类，可以监听该方法
- 当 App 收到（文本、图片等各类）消息时该方法被调用
- 根据 `message.contentType` 判断[消息类型](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Constants/JMSGContentType.html)
- 转型 `message.content` 为[文本内容](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGTextContent.html)并获取文本 `text` 以展示 UI
- Related APIs：
- [图片内容](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGImageContent.html)
- [声音内容](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGVoiceContent.html)
- [文件内容](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGFileContent.html)



### line 13：获取历史消息
---
```objc
NSArray *messages = [(JMSGConversation*)resultObject messageArrayFromNewestWithOffset:nil limit:nil];
```
- 利用 line 6 中的 `resultObject` 转型后获取
- 单聊群聊均可
- Parameters：
- 返回 NSArray<[JMSGMessage](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGMessage.html)* >
- offset：起点。nil 从最新一条开始，n 从最新第 n 条往历史追查
- limit：数量。nil 表全部


### line 14~15：清零单聊未读消息数
---
```objc
JMSGConversation *conversation = [JMSGConversation singleConversationWithUsername:username];
[conversation clearUnreadCount];
```
- Related APIs：
- [清零群聊](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/groupConversationWithGroupId:)



### line 16：获取会话列表
---
```objc
[JMSGConversation allConversations:^(id resultObject, NSError *error) {
}];
```
- 批量获取所有会话列表
- 根据[会话类型](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Constants/JMSGConversationType.html)判断是单聊还是群聊
- Parameters：
- resultObject：NSArray<JMSGConversation*>



### line 17：删除单聊会话
---
```objc
BOOL success = [JMSGConversation deleteSingleConversationWithUsername:username];
```
- Related APIs：
- [删除单聊跨应用会话](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/deleteSingleConversationWithUsername:appKey:)
- [删除群聊会话](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGConversation.html#//api/name/deleteGroupConversationWithGroupId:)



### line 18：批量获取用户详情
---
```objc
[JMSGUser userInfoArrayWithUsernameArray:nameArr completionHandler:^(id resultObject, NSError *error) {
}];
```
- Parameters：
- nameArray：NSArray<NSString*>
- resultObject：NSArray<JMSGUser*>
- Related APIs：
- [获取本用户详情](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGUser.html#//api/name/myInfo)
- [修改本用户详情](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGUser.html#//api/name/updateMyInfoWithParameter:userFieldType:completionHandler:)
- [修改本用户密码](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGUser.html#//api/name/updateMyPasswordWithNewPassword:oldPassword:completionHandler:)









### line 19：创建群组及相关操作
---
```objc
[JMSGGroup createGroupWithName:name desc:desc memberArray:members completionHandler:^(id resultObject, NSError *error) {
}];
```
- Parameters：
- name：群名
- desc：群组描述
- memberArray：成员列表，NSArray<NSString*>
- resultObject：[群组对象 JMSGGroup](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html)
- Related APIs：
- [获取我的群组列表](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/myGroupArray:)
- [获取群组成员列表](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/memberArray)
- [添加成员](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/addMembersWithUsernameArray:completionHandler:)
- [删除成员](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/removeMembersWithUsernameArray:completionHandler:)
- [退群](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/exit:)
- [获取群组详情](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/groupInfoWithGroupId:completionHandler:)
- [修改群组详情](https://docs.jiguang.cn/jmessage/client/jmessage_ios_appledoc_html/Classes/JMSGGroup.html#//api/name/updateGroupInfoWithGroupId:name:desc:completionHandler:)



### line 20：退出登录
---
```objc
[JMSGUser logout:^(id resultObject, NSError *error) {
}];
```


###### 至此一个 IM 的各种基本操作就完了，是不是
# 很简单？
